name: PMR AVANCS - Final Fix
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip apksigner zipalign

      - name: Prepare Resources
        run: |
          # Clonamos Winlator para el cursor
          git clone --depth 1 https://github.com/brunodev85/winlator.git win_src
          mkdir -p assets/img/
          # Extraemos solo los cursores elegantes
          find win_src -name "*cursor*" -exec cp {} assets/img/ \; || true
          
          # Creamos la configuración de PC para tu Honor 90
          echo "preferred_dpi=280" > assets/config.ini
          echo "screen_resolution=1920x1080" >> assets/config.ini
          echo "orientation=landscape" >> assets/config.ini

      - name: Inject and Sign APK
        run: |
          # Copiamos la base
          cp HyperDroid_1.1.apk PMR_AVANCS_Base.apk
          # Inyectamos los nuevos archivos directamente al APK (que es un ZIP)
          zip -ur PMR_AVANCS_Base.apk assets/
          
          # Alineamos el APK para que Android lo acepte
          zipalign -v 4 PMR_AVANCS_Base.apk PMR_AVANCS_Final.apk
          
          # Generamos una firma rápida para que no diga "paquete no válido"
          keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "C=US, O=Android, CN=Android Debug"
          apksigner sign --ks debug.keystore --ks-pass pass:android --key-pass pass:android --out PMR_AVANCS_READY.apk PMR_AVANCS_Final.apk

      - name: Upload PMR AVANCS
        uses: actions/upload-artifact@v4
        with:
          name: PMR-AVANCS-Final-App
          path: PMR_AVANCS_READY.apk
