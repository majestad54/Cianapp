name: PMR AVANCS - Final Solution
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tools
        run: sudo apt-get install -y apktool apksigner zipalign

      - name: Modify APK Assets
        run: |
          # 1. Descomprimimos solo la carpeta assets (donde está la configuración)
          unzip HyperDroid_1.1.apk "assets/*" -d custom_mod
          
          # 2. Inyectamos la configuración de laptop para tu Honor 90
          echo "preferred_dpi=280" > custom_mod/assets/config.ini
          echo "orientation=landscape" >> custom_mod/assets/config.ini
          echo "screen_resolution=1920x1080" >> custom_mod/assets/config.ini
          
          # 3. Inyectamos tu flechita personalizada
          mkdir -p custom_mod/assets/img/
          cp puntero.png custom_mod/assets/img/cursor.png || echo "Falta puntero.png"
          
          # 4. Metemos los cambios de vuelta al APK original sin tocar los recursos rotos
          cp HyperDroid_1.1.apk PMR_AVANCS_Base.apk
          cd custom_mod && zip -ur ../PMR_AVANCS_Base.apk assets/ && cd ..

      - name: Final Sign & Align
        run: |
          # Alineamos para que Android no lo rechace
          zipalign -v 4 PMR_AVANCS_Base.apk PMR_AVANCS_Final.apk
          
          # Creamos la firma digital para que se instale correctamente
          keytool -genkey -v -keystore debug.keystore -storepass android -alias android -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "C=US, O=Android, CN=PMR"
          apksigner sign --ks debug.keystore --ks-pass pass:android --out PMR_AVANCS_READY.apk PMR_AVANCS_Final.apk

      - name: Upload Finished APK
        uses: actions/upload-artifact@v4
        with:
          name: PMR-AVANCS-Ready
          path: PMR_AVANCS_READY.apk
