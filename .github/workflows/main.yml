name: PMR AVANCS - Elite Final Fix
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tools
        run: sudo apt-get install -y apktool apksigner zipalign

      - name: Decompile
        run: apktool d HyperDroid_1.1.apk -o decomp_app

      - name: Deep Clean Resources (Fix Error 207198)
        run: |
          # 1. Eliminamos archivos con nombres inválidos que bloquean aapt
          find decomp_app/res -name "*[A-Z]*" -delete || true
          find decomp_app/res -name "*-*" -delete || true
          # 2. Eliminamos traducciones corruptas que vimos antes
          rm -rf decomp_app/res/values-b+* || true

      - name: Inject Custom Cursor
        run: |
          # Inyectamos tu 'puntero.png' en la ruta de recursos
          mkdir -p decomp_app/assets/img/
          cp puntero.png decomp_app/assets/img/cursor.png || echo "Sube puntero.png a tu repo"

      - name: Force PC Mode (DPI 280)
        run: |
          # Forzamos horizontal y visualización extendida
          echo "preferred_dpi=280" > decomp_app/assets/config.ini
          echo "orientation=landscape" >> decomp_app/assets/config.ini

      - name: Build & Sign
        run: |
          # Usamos --use-aapt2 para mayor compatibilidad con tu Honor 90
          apktool b decomp_app --use-aapt2 -o unsigned.apk
          zipalign -v 4 unsigned.apk PMR_AVANCS_V5.apk
          keytool -genkey -v -keystore debug.keystore -storepass android -alias android -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "C=US, O=Android, CN=PMR"
          apksigner sign --ks debug.keystore --ks-pass pass:android --out PMR_READY.apk PMR_AVANCS_V5.apk

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: PMR-AVANCS-Final
          path: PMR_READY.apk
